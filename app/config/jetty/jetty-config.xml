<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE aspectran PUBLIC "-//ASPECTRAN//DTD Aspectran Configuration 6.0//EN"
        "http://aspectran.github.io/dtd/aspectran-6.dtd">
<aspectran>

    <description>
        An Aspectran configuration for Embedded Jetty Server.
    </description>

    <environment>
        <properties>
            <item name="jetty.startup" value="true" valueType="boolean"/>
            <item name="jetty.server.port" value="8088" valueType="int"/>
            <item name="jetty.server.minThreads" value="3" valueType="int"/>
            <item name="jetty.server.maxThreads" value="10" valueType="int"/>
            <item name="jetty.session.dataStoreDir" value="#{basePath}/temp/sessions"/>
            <item name="jetty.gzip.minGzipSize" value="20000" valueType="int"/>
            <item name="jetty.gzip.inflateBufferSize" value="0" valueType="int"/>
            <item name="jetty.gzip.deflaterPoolCapacity" value="-1" valueType="int"/>
            <item name="jetty.gzip.syncFlush" value="false" valueType="boolean"/>
            <item name="jetty.gzip.includedMethodList" value="GET"/>
            <item name="jetty.gzip.excludedMethodList" value=""/>
        </properties>
    </environment>

    <bean id="jetty.server" class="com.aspectran.jetty.JettyServer">
        <constructor>
            <arguments>
                <item name="threadPool">#{jetty.threadPool}</item>
            </arguments>
        </constructor>
        <properties>
            <item name="autoStart">%{jetty.startup}</item>
            <item name="connectors" type="array">
                <value>#{jetty.connector}</value>
            </item>
            <item name="handler">#{jetty.mainHandler}</item>
        </properties>
    </bean>

    <bean id="jetty.threadPool" class="org.eclipse.jetty.util.thread.QueuedThreadPool" scope="prototype">
        <properties>
            <item name="minThreads">%{jetty.server.minThreads}</item>
            <item name="maxThreads">%{jetty.server.maxThreads}</item>
        </properties>
    </bean>

    <bean id="jetty.connector" class="org.eclipse.jetty.server.ServerConnector" scope="prototype">
        <constructor>
            <arguments>
                <item>#{jetty.server}</item>
            </arguments>
        </constructor>
        <properties>
            <item name="port">%{jetty.server.port}</item>
        </properties>
    </bean>

    <bean id="jetty.mainHandler" class="org.eclipse.jetty.server.handler.HandlerCollection" scope="prototype">
        <properties profile="dev">
            <item name="handlers" type="array">
                <value>#{jetty.gzipHandler}</value>
                <value>#{jetty.requestLog}</value>
            </item>
        </properties>
        <properties profile="!dev">
            <item name="handlers" type="array">
                <value>#{jetty.gzipHandler}</value>
                <value>#{jetty.requestLog}</value>
            </item>
        </properties>
    </bean>

    <bean id="jetty.gzipHandler" class="org.eclipse.jetty.server.handler.gzip.GzipHandler" scope="prototype">
        <properties>
            <item name="minGzipSize" valueType="int">%{jetty.gzip.minGzipSize}</item>
            <item name="inflateBufferSize" valueType="int">%{jetty.gzip.inflateBufferSize}</item>
            <item name="deflaterPoolCapacity" valueType="int">%{jetty.gzip.deflaterPoolCapacity}</item>
            <item name="syncFlush" valueType="boolean">%{jetty.gzip.syncFlush}</item>
            <item name="includedMethodList">%{jetty.gzip.includedMethodList}</item>
            <item name="excludedMethodList">%{jetty.gzip.excludedMethodList}</item>
            <item name="handler">#{jetty.handlerCollection}</item>
        </properties>
    </bean>

    <bean id="jetty.handlerCollection" class="org.eclipse.jetty.server.handler.HandlerCollection" scope="prototype">
        <properties>
            <item name="handlers" type="array">
                <value>#{jetty.contexts}</value>
                <value>#{jetty.defaultHandler}</value>
            </item>
        </properties>
    </bean>

    <bean id="jetty.contexts" class="org.eclipse.jetty.server.handler.ContextHandlerCollection" scope="prototype">
        <properties>
            <item name="handlers" type="array">
                <value>#{jetty.contexts.root}</value>
            </item>
        </properties>
    </bean>

    <bean id="jetty.contexts.root" class="com.aspectran.jetty.JettyWebAppContext" scope="prototype">
        <properties>
            <item name="contextPath">/</item>
            <item name="war">#{basePath}/webapps/root</item>
            <item name="persistTempDirectory" valueType="boolean">true</item>
            <item name="defaultsDescriptor">#{basePath}/config/jetty/webdefault.xml</item>
            <item name="sessionHandler">#{jetty.sessionHandler}</item>
        </properties>
    </bean>

    <bean id="jetty.sessionHandler" class="com.aspectran.jetty.JettySessionHandler" scope="prototype">
        <properties>
            <item name="sessionDataStore">#{jetty.sessionDataStoreFactory}</item>
        </properties>
    </bean>

    <bean id="jetty.sessionDataStoreFactory" class="org.eclipse.jetty.server.session.FileSessionDataStoreFactory" scope="prototype">
        <properties>
            <item name="storeDir" valueType="file">%{jetty.session.dataStoreDir}</item>
            <item name="deleteUnrestorableFiles" valueType="boolean">true</item>
        </properties>
    </bean>

    <bean id="jetty.defaultHandler" class="org.eclipse.jetty.server.handler.DefaultHandler" scope="prototype"/>

    <bean id="jetty.requestLog" class="org.eclipse.jetty.server.handler.RequestLogHandler" scope="prototype">
        <properties>
            <item name="requestLog">#{jetty.customRequestLog}</item>
        </properties>
    </bean>

    <bean id="jetty.customRequestLog" class="org.eclipse.jetty.server.CustomRequestLog" scope="prototype">
        <constructor>
            <arguments>
                <item>#{jetty.asyncRequestLogWriter}</item>
                <item>#{field:org.eclipse.jetty.server.CustomRequestLog^EXTENDED_NCSA_FORMAT}</item>
            </arguments>
        </constructor>
    </bean>

    <bean id="jetty.asyncRequestLogWriter" class="org.eclipse.jetty.server.AsyncRequestLogWriter" scope="prototype">
        <constructor>
            <arguments>
                <item>#{basePath}/logs/jetty-yyyy_mm_dd.request.log</item>
            </arguments>
        </constructor>
        <properties>
            <item name="filenameDateFormat">yyyy_MM_dd</item>
            <item name="retainDays" valueType="int">90</item>
            <item name="append" valueType="boolean">true</item>
            <item name="timeZone">GMT+9</item>
        </properties>
    </bean>

</aspectran>