<!DOCTYPE aspectran PUBLIC "-//ASPECTRAN//DTD Aspectran Configuration 5.0//EN"
        "http://aspectran.github.io/dtd/aspectran-5.dtd">

<aspectran>

    <description>
        An Aspectran configuration for the Web Application.
        Note that names of translets that match the request URI
        always start with a forward slash (/).
    </description>

    <environment profile="h2">
        <properties>
            <item name="mybatis.environment" value="default"/>
            <item name="mybatis.db.driver" value="%{classpath:memo.db.properties^driver}"/>
            <item name="mybatis.db.url" value="%{classpath:memo.db.properties^url}"/>
            <item name="mybatis.db.username" value="%{classpath:memo.db.properties^username}"/>
            <item name="mybatis.db.password" value="%{classpath:memo.db.properties^password}"/>
        </properties>
    </environment>

    <environment profile="mysql">
        <properties>
            <item name="mybatis.environment" value="default"/>
            <item name="mybatis.db.driver" value="%{classpath:db.encrypted.properties^driver}"/>
            <item name="mybatis.db.url" value="%{classpath:db.encrypted.properties^url}"/>
            <item name="mybatis.db.username" value="%{classpath:db.encrypted.properties^username}"/>
            <item name="mybatis.db.password" value="%{classpath:db.encrypted.properties^password}"/>
        </properties>
    </environment>

    <bean id="sqlSessionFactory" class="com.aspectran.support.orm.mybatis.SimpleSqlSessionFactoryBean">
        <properties>
            <item name="configLocation" value="/config/mybatis/mybatis-config.xml"/>
            <item name="environment" value="%{mybatis.environment}"/>
            <item name="properties" type="properties">
                <value name="driver">%{mybatis.db.driver}</value>
                <value name="url">%{mybatis.db.url}</value>
                <value name="username">%{mybatis.db.username}</value>
                <value name="password">%{mybatis.db.password}</value>
            </item>
        </properties>
    </bean>

    <bean id="sqlSessionTxAdvice" class="com.aspectran.support.orm.mybatis.SqlSessionTxAdvice" scope="prototype">
        <constructor>
            <arguments>
                <item><call bean="sqlSessionFactory"/></item>
            </arguments>
        </constructor>
    </bean>

    <aspect id="sqlSessionTxAspect">
        <description>
            본 Aspect는 SqlSession을 열고 닫는 메소드를 자동으로 호출합니다.
            DAO 메소드가 호출되기 전에 자동으로 open() 메소드를 호출하여 SqlSession을 열고,
            Translet 실행 중에 예외가 발생하지 않았다면 commit() 메소드를 호출합니다.
            마지막으로 자원을 해제하기 위해 close() 메소드를 호출합니다.
        </description>
        <joinpoint target="translet">
            pointcut: {
                +: **@**.*Dao
            }
        </joinpoint>
        <advice bean="sqlSessionTxAdvice">
            <before>
                <action method="open"/>
            </before>
            <after>
                <action method="commit"/>
            </after>
            <finally>
                <action method="close"/>
            </finally>
        </advice>
    </aspect>

</aspectran>